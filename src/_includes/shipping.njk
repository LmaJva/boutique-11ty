<label for="destination" class="display-none">Destination :</label>
<select id="destination" name="destination">
  {% for zone, data in shipping.grille_tarifs %}
    {% for country in data.pays[page.lang] %}
      <option value="{{ zone }}">
        {{ country }}
      </option>
    {% endfor %}
  {% endfor %}
</select>

<p>
  Frais de transport (colissimo la Poste) : 
  <span id="shipping-cost">--</span> €
</p>

<script>
  const shippingPoint = 9; // Points d'encombrement des objets
  const shippingWeight = 1000; // Poids en grammes des objets
  const shippingType = 'colis_base'; // Type de colis sélectionné
  const shippingData = {{ shipping | dump | safe }}; // Injection des données YAML

  document.addEventListener('DOMContentLoaded', function () {
    const destinationSelect = document.getElementById('destination');
    const shippingCostElement = document.getElementById('shipping-cost');

    function calculateShippingCost() {
      const selectedZone = destinationSelect.value;

      // Vérifie si une zone est sélectionnée
      if (!selectedZone || !shippingData.grille_tarifs[selectedZone]) {
        shippingCostElement.textContent = '--';
        return;
      }

      // Gère le cas du type de colis "sans_envois"
      if (shippingType === 'sans_envoi') {
        destinationSelect.classList.add('display-none');
        shippingCostElement.textContent = '0';
        
        return;
      }

      // Récupère les données du type de colis
      const colisData = shippingData.types_colis[shippingType];
      if (!colisData) {
        shippingCostElement.textContent = '--';
        return;
      }
      const colisWeight = colisData.poids_emballage; // Poids d'un colis vide
      const colisCapacity = colisData.capacite_points; // Capacité maximale en points

      // Calcule le nombre de colis nécessaires
      const numberOfColis = Math.ceil(shippingPoint / colisCapacity);

      // Calcule le poids total (objets + poids des colis), en s'assurant qu'il ne peut pas être négatif
      let totalWeight = shippingWeight + (numberOfColis * colisWeight);
      totalWeight = Math.max(totalWeight, 0); // Évite les poids négatifs

      // Récupère les tarifs de la zone sélectionnée
      const tarifs = shippingData.grille_tarifs[selectedZone].tarifs;

      // Trouve le tarif correspondant au poids total
      const tarif = tarifs.find(t => totalWeight <= t.poids_max);

      // Affiche le tarif ou "--" si non trouvé
      shippingCostElement.textContent = tarif ? `${tarif.tarif}` : '--';
    }

    // Ajoute un écouteur pour recalculer les frais à chaque changement de destination
    destinationSelect.addEventListener('change', calculateShippingCost);

    // Calcul initial au chargement de la page
    calculateShippingCost();
  });
</script>
